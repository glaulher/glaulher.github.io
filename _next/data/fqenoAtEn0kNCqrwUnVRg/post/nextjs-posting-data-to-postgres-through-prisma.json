{"pageProps":{"frontmatter":{"title":"Next.js posting data to Postgres through Prisma","metaTitle":"Next.js posting data to Postgres through Prisma","metaDesc":"Posting data to Postgres using Prisma in Next.js","socialImage":"images/27-10-2021.jpg","date":"2021-10-27","tags":["nextjs","prisma"]},"content":"\nHi everyone! In the past couple of articles, we have been looking at Prisma and Postgres databases.\n\nIn this article, I will create a Next.js app that can post data to a Postgres database.\n\nWhat we'll be building:\n\n- User signs in with Spotify\n- User loads their playlists from Spotify\n- User can sync one of the playlists to our Postgres database\n\nIt will look like this:\n\n<!-- ![Next.js posting data to Postgres through Prisma](https://cdn.hashnode.com/res/hashnode/image/upload/v1634477800714/AYIILKoPa.gif) -->\n<video autoplay loop muted playsinline>\n  <source src=\"https://res.cloudinary.com/daily-dev-tips/video/upload/q_auto/prisma-post_ocdqqw.webm\" type=\"video/webm\" />\n  <source src=\"https://res.cloudinary.com/daily-dev-tips/video/upload/q_auto/prisma-post_galhvt.mp4\" type=\"video/mp4\" />\n</video>\n\n## Setting up the starting point\n\nI'm going to use the [Spotify login example](https://daily-dev-tips.com/posts/retrieving-a-persons-spotify-playlist-in-nextjs/) we made yesterday as the starting point for today's article.\n\nIf you want to follow along, download it from [GitHub](https://github.com/rebelchris/next-spotify-login) here.\n\nThe first thing we need to do is add the Prisma dependencies to our application.\n\n```bash\nnpm i -D prisma\nnpm i @prisma/client\n```\n\nThen we need to initialize the Prisma client.\n\n```bash\nnpx prisma init\n```\n\nThis will generate the Prisma folder and add a database URL to our `.env` file.\n\nOpen up the `.env` file and paste your [Postgres database URL](https://daily-dev-tips.com/posts/setting-up-a-free-postgresql-database-on-heroku/).\n\n## Set up the database\n\nThe next thing we need to do is define a schema for our playlist. Open the `prisma/schema.prisma` file and add the following schema at the bottom.\n\n```js\nmodel Playlist {\n  id           Int @default(autoincrement()) @id\n  title        String\n  image        String?\n  uri          String @unique\n  addedBy      String\n}\n```\n\nFrom here, we need to build our database.\n\n```bash\nnpx prisma db push\n```\n\nAs well as generate the local schema:\n\n```bash\nnpx prisma generate\n```\n\n## Creating an API endpoint to post our entity\n\nWe already have a `playlists` endpoint so let's leverage that one but modify it to accept `POST` requests.\n\nOpen the `pages/api/playlists.js` file and start by importing the Prisma requirements.\n\n```js\nimport { PrismaClient } from '@prisma/client';\nconst prisma = new PrismaClient();\n```\n\nNow let's modify the handler to do something on `POST` and `GET`.\n\n```js\nconst handler = async (req, res) => {\n  const {\n    token: { accessToken, email },\n  } = await getSession({ req });\n  if (req.method === 'POST') {\n    // Do post stuff\n  } else if (req.method === 'GET') {\n    const response = await getUsersPlaylists(accessToken);\n    const { items } = await response.json();\n    return res.status(200).json({ items });\n  }\n  res.end();\n};\n```\n\nAs for the `POST` section, we want to extract the correct data from our post query and create a new object to send to our database.\n\n```js\nif (req.method === 'POST') {\n  const { body } = req;\n  const {\n    name,\n    images: { 0: { url } = {} },\n    uri,\n  } = JSON.parse(body);\n  const playlistItem = {\n    title: name,\n    image: url,\n    uri: uri,\n    addedBy: email,\n  };\n}\n```\n\nThen all we need to do is call our Prisma client and use the `create` function to insert our item.\n\n```js\nconst playlist = await prisma.playlist.create({\n  data: playlistItem,\n});\nreturn res.status(200).json(playlist);\n```\n\nAnd that's it, if we now perform a `POST` request to this API endpoint, our playlist will be added.\n\n## Creating the frontend action\n\nFor the frontend part, let's open up our `index.js` page.\nInside the map function add a button with a click action like so:\n\n```js\n{\n  list.map((item) => (\n    <div key={item.id}>\n      <h1>{item.name}</h1>\n      <img src={item.images[0]?.url} width='100' />\n      <br />\n      <button onClick={() => saveToDatabase(item)}>Save in database</button>\n    </div>\n  ));\n}\n```\n\nNow let's go ahead and make this `saveToDatabase` function.\n\n```js\nconst saveToDatabase = async (item) => {\n  const res = await fetch('api/playlists', {\n    method: 'POST',\n    body: JSON.stringify(item),\n  });\n  const data = await res.json();\n};\n```\n\nIn our case, we are just passing the API request but not doing anything with the return data yet.\n\nThis is perfect as once we click the button, it will call this function and post it to our API.\nWhich in return adds a new entry in our database.\n\n![Database entries from Prisma Next.js](https://cdn.hashnode.com/res/hashnode/image/upload/v1634477581356/AS1_2nxU7.png)\n\nYou can also find the complete code on [GitHub](https://github.com/rebelchris/next-spotify-login/tree/post-data).\n\n### Thank you for reading, and let's connect!\n\nThank you for reading my blog. Feel free to subscribe to my email newsletter and connect on [Facebook](https://www.facebook.com/DailyDevTipsBlog) or [Twitter](https://twitter.com/DailyDevTips1)\n"},"__N_SSG":true}